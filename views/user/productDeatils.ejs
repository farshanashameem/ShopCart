<%- include('../partials/head', { title: product.name }) %>

<body>
  <%- include('../partials/navbar') %>

  <div class="container mt-5">
    <div class="row">
      <!-- Product Images -->
      <div class="col-md-6">
        <div class="row g-2">
          <% productVariant.images.forEach((img, index) => { %>
            <div class="col-6">
              <img src="/uploads/products/<%= img %>" class="img-fluid border rounded" alt="product image">
            </div>
          <% }) %>
        </div>
      </div>

      <!-- Product Details -->
      <div class="col-md-6">
        <h5 class="text-muted"><%= product.genderId %> Fit</h5>
        <h2><%= product.name %></h2>

        <!-- Rating -->
        <div class="d-flex align-items-center mb-2">
          <% for (let i = 1; i <= 5; i++) { %>
            <i class="bi bi-star-fill text-<%= i <= averageRating ? 'warning' : 'secondary' %>"></i>
          <% } %>
          <span class="ms-2 fw-bold"><%= averageRating.toFixed(1) %></span>
        </div>

        <!-- Price -->
        <h4 class="text-danger">$<%= selectedVariant.discountPrice || selectedVariant.basePrice %></h4>

        <!-- Size Selection -->
        <label class="form-label mt-3">Select a Size:</label>
        <div class="btn-group" role="group">
          <% availableSizes.forEach(size => { %>
            <button type="button" class="btn btn-outline-dark"><%= size %></button>
          <% }) %>
        </div>

        <!-- Color Options -->
        <p class="mt-3 mb-1">Colour: <strong><%= selectedColorName %></strong></p>
        <% availableColors.forEach(color => { %>
          <button class="btn border rounded-circle me-2"
                  style="width: 30px; height: 30px; background-color: <%= color.hexCode %>;"
                  title="<%= color.name %>">
          </button>
        <% }) %>

        <!-- Buttons -->
        <div class="mt-4 d-grid gap-2">
          <button class="btn btn-danger">Add to Wishlist</button>
          <button class="btn btn-dark">Add to Cart</button>
        </div>

        <!-- Description -->
        <ul class="nav nav-tabs mt-4" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#desc">Description</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#review">Reviews</button>
          </li>
        </ul>

        <div class="tab-content mt-3">
          <div class="tab-pane fade show active" id="desc">
            <p><%= product.description %></p>
            <p><strong>Fit:</strong> <%= fit.name %></p>
            <p><strong>Material:</strong> 95% cotton, 5% elastane</p>
          </div>

          <div class="tab-pane fade" id="review">
            <% reviews.forEach(review => { %>
              <div class="mb-2">
                <div class="fw-bold"><%= review.userId.name || 'Anonymous' %></div>
                <div class="text-warning">
                  <% for (let i = 1; i <= 5; i++) { %>
                    <i class="bi bi-star-fill text-<%= i <= review.rating ? 'warning' : 'secondary' %>"></i>
                  <% } %>
                </div>
                <div><%= review.comment %></div>
              </div>
            <% }) %>
          </div>
        </div>
      </div>
    </div>

    <!-- You May Also Like -->
    <div class="mt-5">
      <h4>You May Also Like</h4>
      <div class="row">
        <% relatedProducts.forEach(p => { %>
          <div class="col-6 col-md-3">
            <div class="card">
              <img src="/uploads/products/<%= p.thumbnail %>" class="card-img-top" alt="<%= p.name %>">
              <div class="card-body text-center">
                <h6 class="card-title"><%= p.name %></h6>
                <p class="text-muted">$<%= p.basePrice %></p>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    </div>
  </div>

  <%- include('../partials/footer') %>
  <%- include('../partials/scripts') %>
</body>
<!--const product = await Products.findById(productId)
  .populate('fitId')
  .populate('productTypeId');

const productVariants = await ProductVariant.find({ productId }).populate('colorId');

// Get distinct colors and sizes
const availableColors = [...new Map(productVariants.map(v => [v.colorId._id, v.colorId])).values()];
const availableSizes = [...new Set(productVariants.map(v => v.size))];

// Select default variant (e.g., first one)
const selectedVariant = productVariants[0];
const selectedColorName = selectedVariant.colorId.name;

// Calculate average rating
const reviews = await Review.find({ productId });
const averageRating = reviews.length
  ? reviews.reduce((acc, r) => acc + r.rating, 0) / reviews.length
  : 0;

// You May Also Like (dummy logic â€” enhance it later)
const relatedProducts = await Products.find({ genderId: product.genderId }).limit(4);
-->