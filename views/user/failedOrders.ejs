<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head', { title: 'ShopCart - Failed Orders' }) %>
        <style>
            body {
                font-family: Arial, sans-serif;
                background-color: #f8f9fa !important;
            }

            .order-card {
                background: #fff;
                border-radius: 10px;
                box-shadow: 0px 2px 8px rgba(0, 0, 0, 0.1);
                padding: 20px;
                margin-bottom: 20px;
            }

            .product-item {
                display: flex;
                align-items: center;
                gap: 15px;
                margin-bottom: 10px;
                flex-wrap: wrap;
            }

            .product-item img {
                height: 80px;
                width: 80px;
                object-fit: cover;
                border-radius: 8px;
            }

            .retry-btn {
                margin-top: 10px;
            }
        </style>
</head>

<body>
    <%- include('../partials/navbar') %>

        <div class="container my-5">
            <h2 class="mb-4">Failed Orders</h2>

            <% if (orders.length===0) { %>
                <div class="alert alert-info">No failed orders found.</div>
                <% } else { %>
                    <% orders.forEach(order=> { %>
                        <div class="order-card">
                            <p><strong>Order ID:</strong>
                                <%= order.orderId %>
                            </p>
                            <p><strong>Amount:</strong> â‚¹<%= order.amount %>
                            </p>
                            <p><strong>Payment Method:</strong>
                                <%= order.paymentMethod %>
                            </p>
                            <p><strong>Reason:</strong>
                                <%= order.reason %>
                            </p>
                            <p><strong>Date:</strong>
                                <%= order.createdAt.toLocaleDateString("en-IN") %>
                            </p>

                            <div class="mt-3">
                                <h6>Products:</h6>
                                <% order.products.forEach(pdt=> { %>
                                    <div class="product-item">
                                        <img src="<%= pdt.image %>" alt="<%= pdt.name %>">
                                        <div>
                                            <p class="mb-1"><strong>
                                                    <%= pdt.name %>
                                                </strong></p>
                                            <p class="mb-0">Quantity: <%= pdt.quantity %>
                                            </p>
                                        </div>
                                    </div>
                                    <% }) %>
                            </div>

                            <!-- Retry button (only if order is still failed/active) -->
                            <% if ( order.isActive !==false) { %>
                               <form class="retryForm" data-id="<%= order.id %>">
                                <button type="button" class="btn btn-danger retry-btn retryBtn">Retry Payment </button>
                                </form>

                                <% } %>
                        </div>
                        <% }) %>
                            <% } %>
        </div>

        <%- include('../partials/footer') %>
            <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
          
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  document.querySelectorAll('.retryBtn').forEach(button => {
    button.addEventListener('click', async (e) => {
      e.preventDefault();
      const form = e.target.closest('.retryForm');
      const orderId = form.dataset.id;

      try {
        const response = await fetch('/retry-payment', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ id: orderId }),
        });

        const result = await response.json();

        if (result.success) {
          Swal.fire({
            icon: 'success',
            title: 'Retrying Payment',
            text: result.message,
            timer: 1500,
            showConfirmButton: false
          }).then(() => {
            window.location.href = '/select-address';
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Retry Failed',
            text: result.message || 'Something went wrong. Please try again.',
          });
        }
      } catch (error) {
        console.error(error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Network error. Please try again later.',
        });
      }
    });
  });
</script>





</body>

</html>