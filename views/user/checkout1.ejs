<!-- checkout.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('../partials/head', { title: 'ShopCart - Checkout' }) %>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

       
    </style>
</head>
<body>
    <%- include('../partials/navbar') %>

    <div class="checkout-container">
        <!-- Address Section -->
        <div class="address-section">
            <h2 style="text-align:center;">SELECT DELIVERY ADDRESS</h2>
            <form action="/checkout" method="POST">
                <% addresses.forEach((address, index) => { %>
                    <label class="address-card <%= index === 0 ? 'selected' : '' %>">
                        <input type="radio" name="selectedAddress" value="<%= address._id %>" <%= index === 0 ? 'checked' : '' %>/>

                        <div class="address-details">
                          <strong><%= address.name %> <%= address.phoneNumber %></strong><br>
                            <%= address.address %>, <%= address.city %>, <%= address.state %> - <%= address.pincode %>

                        </div>
                        <div class="address-type"><%= address.type %></div>
                        <% 
                            let displayAddress = { ...address._doc }; 
                            if (displayAddress.phoneNumber) {
                                displayAddress.phoneNumber = displayAddress.phoneNumber.slice(3); // remove first 3 chars
                            }
                        %>
                        <div class="edit-icon" onclick='editAddress(<%- JSON.stringify(displayAddress) %>)'>⋮</div>
                    </label>

                    
                        
                <% }) %>
                


                 
                <div class="add-address-btn" onclick="showAddressBar()">+ Add a new address</div>
            </form>




            <div class="addAddress me-2 <%= showAddressBar ? '' : 'd-none' %>" id="addressBar">
                            <form id="addressForm" action=" "
                                method="POST" class="p-4">

                                
                             <input type="text" name="name" placeholder="Full Name"
                                class="col-md-5 col-sm-12 border-round"
                                 value="<%= old?.name || '' %>">
                                <% if (errors?.name) { %>
                                    <p class="text-danger m-0">
                                        <%= errors.name %>
                                    </p>
                                    <% } %>

                                        <!-- Phone -->
                             <input type="text" name="phone" placeholder="10 Digit phone number"
                                class="col-md-5 col-sm-12 border-round"
                                value="<%= old?.phone ||  '' %>">
                                        <% if (errors?.phone) { %>
                                            <p class="text-danger m-0">
                                                <%= errors.phone %>
                                            </p>
                                            <% } %>

                                 <!-- Pincode -->
                             <input type="number" name="pin" placeholder="Pin Code"
                                class="col-md-5 col-sm-12 border-round"
                                 value="<%= old?.pin ||  '' %>">
                                         <% if (errors?.pin) { %>
                                            <p class="text-danger m-0">
                                            <%= errors.pin %>
                                             </p>
                                         <% } %>

                                 <!-- Locality -->
                             <input type="text" name="locality" placeholder="Locality"
                                    class="col-md-5 col-sm-12 border-round"
                                     value="<%= old?.locality ||  '' %>">
                                        <% if (errors?.locality) { %>
                                         <p class="text-danger m-0">
                                           <%= errors.locality %>
                                         </p>
                                        <% } %>

                                <!-- Address -->
                             <textarea name="address" id="address"
                               class="col-10 border-round"
                               placeholder="Address (Area and Street)"><%= old?.address ||'' %></textarea>
                                  <% if (errors?.address) { %>
                                    <p class="text-danger m-0">
                                        <%= errors.address %>
                                    </p>
                                    <% } %>

                                        <!-- City -->
                             <input type="text" name="city"
                                placeholder="City/District/Town"
                                class="col-md-5 col-sm-12 border-round"
                                value="<%= old?.city ||  '' %>">
                                     <% if (errors?.city) { %>
                                        <p class="text-danger m-0">
                                        <%= errors.city %>
                                       </p>
                                     <% } %>

                                     <!-- State -->
                             <select name="state" id="state"
                               class="col-md-5 col-sm-12">
                               <option value="">-- Select State --
                                </option>
                                <option value="AN" <%=old?.state==="AN" ? "selected" : "" %>> Andaman and Nicobar Islands</option>
                                <option value="AP" <%=old?.state==="AP" ? "selected" : "" %>>Andhra Pradesh</option>
                                <option value="AR" <%=old?.state==="AR" ? "selected" : "" %>>Arunachal Pradesh</option>
                                <option value="AS" <%=old?.state==="AS"   ? "selected" : "" %>>Assam </option>
                                <option value="BR" <%=old?.state==="BR"  ? "selected" : "" %>>Bihar </option>
                                <option value="CH" <%=old?.state==="CH" ? "selected" : "" %>>Chandigarh </option>
                                <option value="CG" <%=old?.state==="CG"  ? "selected" : "" %>  >Chhattisgarh</option>
                                <option value="DN" <%=old?.state==="DN"  ? "selected" : "" %>>Dadra and Nagar Haveli and Daman and Diu </option>
                                <option value="DL" <%=old?.state==="DL"  ? "selected" : "" %>>Delhi </option>
                                <option value="GA" <%=old?.state==="GA" ? "selected" : "" %>>Goa </option>
                                <option value="GJ" <%=old?.state==="GJ"  ? "selected" : "" %>>Gujarat </option>
                                <option value="HR" <%=old?.state==="HR" ? "selected" : "" %>>Haryana </option>
                                <option value="HP" <%=old?.state==="HP" ? "selected" : "" %>>Himachal Pradesh</option>
                                <option value="JK" <%=old?.state==="JK"  ? "selected" : "" %>>Jammu and Kashmir</option>
                                <option value="JH" <%=old?.state==="JH"  ? "selected" : "" %>>Jharkhand </option>
                                <option value="KA" <%=old?.state==="KA"  ? "selected" : "" %>>Karnataka </option>
                                <option value="KL" <%=old?.state==="KL"  ? "selected" : "" %>>Kerala  </option>
                                <option value="LA" <%=old?.state==="LA"  ? "selected" : "" %>>Ladakh </option>
                               <option value="LD" <%=old?.state==="LD" ? "selected" : "" %>>Lakshadweep </option>
                               <option value="MP" <%=old?.state==="MP" ? "selected" : "" %>>Madhya Pradesh</option>
                                <option value="MH" <%=old?.state==="MH"  ? "selected" : "" %>>Maharashtra </option>
                                 <option value="MN" <%=old?.state==="MN" ? "selected" : "" %>>Manipur </option>
                                <option value="ML" <%=old?.state==="ML"  ? "selected" : "" %>>Meghalaya </option>
                                <option value="MZ" <%=old?.state==="MZ"  ? "selected" : "" %>>Mizoram </option>
                                <option value="NL" <%=old?.state==="NL"  ? "selected" : "" %>>Nagaland </option>
                                <option value="OD" <%=old?.state==="OD"  ? "selected" : "" %>>Odisha </option>
                               <option value="PY" <%=old?.state==="PY" ? "selected" : "" %>>Puducherry  </option>
                                <option value="PB" <%=old?.state==="PB" ? "selected" : "" %>>Punjab </option>
                                <option value="RJ" <%=old?.state==="RJ"  ? "selected" : "" %>>Rajasthan </option>
                                 <option value="SK" <%=old?.state==="SK"  ? "selected" : "" %>>Sikkim </option>
                                <option value="TN" <%=old?.state==="TN" ? "selected" : "" %>>Tamil Nadu </option>
                                <option value="TS" <%=old?.state==="TS" ? "selected" : "" %>>Telangana </option>
                                <option value="TR" <%=old?.state==="TR" ? "selected" : "" %>>Tripura  </option>
                                <option value="UP" <%=old?.state==="UP" ? "selected" : "" %>>Uttar Pradesh</option>
                                <option value="UK" <%=old?.state==="UK" ? "selected" : "" %>>Uttarakhand </option>
                                 <option value="WB" <%=old?.state==="WB"  ? "selected" : "" %>>West Bengal </option>
                         </select>
                           <% if (errors?.state) { %>
                                <p class="text-danger m-0">
                               <%= errors.state %>
                              </p>
                            <% } %>
                                                                                
                          <!-- Landmark -->
                       <input type="text" name="landmark" placeholder="Landmark (optional)" class="col-md-5 col-sm-12 border-round"
                             value="<%= old?.landmark ||'' %>">
                              <% if (errors?.landmark) { %>
                                 <p class="text-danger m-0">
                                    <%= errors.landmark %>
                                 </p>
                                 <% } %>
                                                                                
                         <!-- Alternate Phone -->
                        <input type="number" name="altnumber" placeholder="Alternate Phone"
                            class="col-md-5 col-sm-12 border-round" value="<%= old?.altnumber ||  '' %>">
                               <% if (errors?.altnumber) { %>
                                 <p class="text-danger m-0">
                                    <%= errors.altnumber %>
                                  </p>
                                <% } %>
                                                                                
                          <!-- Address Type -->
                         <div class="mt-3">
                            <label>Address Type</label><br>
                            <input type="radio" id="home" name="addressType" value="home" <%=old?.addressType==="home"? "checked" : "" %>>
                             <label for="home">Home</label>
                            <input type="radio" id="office" name="addressType" value="office"
                               <%=old?.addressType==="office" ? "checked" : "" %>>
                            <label for="office">Office</label>

                             <% if (errors?.addressType) { %>
                                 <p class="text-danger m-0">
                                    <%= errors.addressType %>
                                  </p>
                                <% } %>
                          </div>
                                                                                
                          <!-- Buttons -->
                         <button type="submit" class="btn btn-outline-primary">SAVE</button>
                        <button type="button" class="btn btn-outline-danger" onclick="hideAddressBar()">Cancel</button>
                     </form>
            </div>
        </div>

        <!-- Order Summary Section -->
        <div class="order-summary">
            <h3>Order Summary</h3>
            <% cart.items.forEach(item => { %>
                 <p>
                <%= item.name %> ( <%= item.quantity %> items )
                <span class="float-end">₹<%= item.price * item.quantity %></span>
              </p>
              <p>
                Discount 
                <span class="float-end" style="color: green;"> - ₹<%= (item.price - item.discountPrice) * item.quantity %></span>
              </p>
            
            <div class="summary-item">
                <span>Delivery Charges</span>
                <span style="color: green;">
                    <% if ( item.discountPrice * item.quantity < 300) { %>
                    ₹50
                    <% } else { %>
                    Free
                    <% } %>
                </span>
            </div>
            
            <div class="summary-item">
                <span>Platform fee</span>
                <span>₹ 0</span>
            </div>


            <div class="total mb-3">
                Total In Rupees: ₹
                <%= (item.discountPrice * item.quantity < 300) ? (cart.total + 50) : cart.total %>
            </div>
            <% }) %>
           <button type="button" id="continueBtn" class="continue-btn bg-dark ps-4 pe-4 mt-3 d-block w-100 text-center">
                Continue
            </button>
        </div>
    </div>

    <%- include('../partials/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Highlight selected address
        const addressCards = document.querySelectorAll('.address-card');
        addressCards.forEach(card => {
            card.addEventListener('click', () => {
                addressCards.forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                card.querySelector('input[type="radio"]').checked = true;
            });
        });
function showAddressBar() {
    const form = document.getElementById('addressForm');
    form.action = '/select-address/addAddress';  // default action for adding
    form.reset();                 // clear all fields
    document.getElementById('addressBar').classList.remove('d-none');
}

function editAddress(address) {
    const form = document.getElementById('addressForm');
    form.action = '/select-address/updateAddress/' + address._id;

    // Fill form fields with address data
    form.name.value = address.name || '';
    form.phone.value = address.phoneNumber || '';
    form.pin.value = address.pincode || '';
    form.locality.value = address.locality || '';
    form.address.value = address.address || '';
    form.city.value = address.city || '';
    form.state.value = address.state || '';
    form.landmark.value = address.landmark || '';
    form.altnumber.value = address.alternateNumber || '';

    if(address.type === 'home') {
        form.querySelector('input[name="addressType"][value="home"]').checked = true;
    } else {
        form.querySelector('input[name="addressType"][value="office"]').checked = true;
    }

    document.getElementById('addressBar').classList.remove('d-none');
}

function hideAddressBar() {
    document.getElementById('addressBar').classList.add('d-none');
}


document.getElementById('continueBtn').addEventListener('click', () => {
    // Get the selected address radio input
    const selectedRadio = document.querySelector('input[name="selectedAddress"]:checked');
    if (!selectedRadio) {
        alert("Please select an address!");
        return;
    }
    const addressId = selectedRadio.value;

    // Option 1: Redirect to next page with addressId as query param
    window.location.href = `/payment?addressId=${addressId}`;
});

    </script>

</body>
</html>
