<!-- orders.ejs -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('../partials/head', { title: 'ShopCart - My Orders' }) %>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f7f8fa !important;
      }

      h2 {
        font-weight: 600;
        color: #333;
      }

      .order-card {
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 2rem;
        padding: 1.5rem;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }

      .order-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.12);
      }

      .order-item {
        display: flex;
        align-items: center;
        gap: 1.2rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 1rem;
      }

      .order-item img {
        width: 100px;
        height: 100px;
        object-fit: cover;
        border-radius: 12px;
        border: 1px solid #ddd;
      }

      .order-info h5 {
        margin: 0;
        font-weight: 600;
        color: #222;
      }

      .order-info p {
        margin: 4px 0;
        color: #555;
        font-size: 0.95rem;
      }

      /* Tracking Steps */
      .track {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1.5rem;
        position: relative;
      }

      .track::before {
        content: "";
        position: absolute;
        top: 16px;
        left: 0;
        width: 100%;
        height: 4px;
        background: #dcdcdc;
        z-index: 1;
        border-radius: 4px;
      }

      .step {
        text-align: center;
        flex: 1;
        position: relative;
        z-index: 2;
      }

      .circle {
        width: 22px;
        height: 22px;
        background-color: #dcdcdc;
        border-radius: 50%;
        margin: 0 auto;
        margin-bottom: 8px;
        transition: background-color 0.3s ease;
      }

      .step.active .circle {
        background-color: #0d6efd;
      }

      .step p {
        font-size: 0.9rem;
        color: #555;
        font-weight: 500;
      }

      .step small {
        display: block;
        color: #888;
        font-size: 0.8rem;
      }

      /* Buttons & Badges */
      .btn-cancel,
      .btn-return {
        border-radius: 25px;
        font-weight: 500;
        padding: 8px 16px;
        margin: 1rem 0.5rem;
        transition: all 0.2s ease;
      }

      .btn-cancel:hover {
        background-color: #c82333;
        color: #fff;
      }

      .btn-return:hover {
        background-color: #f0ad4e;
        color: #fff;
      }

      .badge {
        margin-top: 1rem;
        padding: 8px 12px;
        border-radius: 12px;
        font-size: 0.85rem;
      }

      /* Failed Orders Link */
      .failed-link {
        display: inline-block;
        background-color: #ff9800;
        color: #fff !important;
        font-weight: 500;
        padding: 8px 16px;
        border-radius: 25px;
        transition: background-color 0.3s ease;
      }

      .failed-link:hover {
        background-color: #e68900;
        text-decoration: none;
      }
    </style>
  </head>

  <body>
    <%- include('../partials/navbar') %>

    <div class="container my-5">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>My Orders</h2>
        <a href="/failedOrders" class="failed-link">
          <i class="bi bi-exclamation-triangle me-1"></i> Failed Orders
        </a>
      </div>

      <!-- Orders Loop -->
      <% orders.forEach(order=> { %>
        <div class="order-card">
          <!-- Order Item -->
          <div class="order-item">
            <a href="/orderedItem/<%= order.id %>" class="text-decoration-none">
              <img src="<%= order.image %>" alt="<%= order.name %>" />
            </a>
            <div class="order-info">
              <h5><%= order.name %></h5>
              <p>Quantity: <%= order.quantity %> | â‚¹<%= order.price %></p>
              <p>Size: <%= order.size %></p>
            </div>
          </div>

          <!-- Tracking -->
          <div class="track"
            data-status="<%= order.status %>"
            data-expected="<%= order.expectedDate ? new Date(order.expectedDate).toDateString() : '' %>"
            data-return="<%= (order.returnStatus === 'approved' || order.returnStatus === 'refunded') && order.returnDate ? new Date(order.returnDate).toDateString() : '' %>"
            data-return-pending="<%= order.returnStatus === 'pending'||order.returnStatus==='approved' || order.returnStatus==='refunded' ? 'true' : 'false' %>">
            
            <div class="step <%= ['placed','shipped','out-for-delivery','delivered'].includes(order.status) || order.returnStatus ? 'active' : '' %>">
              <div class="circle"></div>
              <p>Order Placed</p>
              <small><%= order.statusDates.placed ? new Date(order.statusDates.placed).toDateString() : '' %></small>
            </div>

            <div class="step <%= ['shipped','out-for-delivery','delivered'].includes(order.status) || order.returnStatus ? 'active' : '' %>">
              <div class="circle"></div>
              <p>Shipped</p>
              <small><%= order.statusDates.shipped ? new Date(order.statusDates.shipped).toDateString() : '' %></small>
            </div>

            <div class="step <%= ['out-for-delivery','delivered'].includes(order.status) || order.returnStatus ? 'active' : '' %>">
              <div class="circle"></div>
              <p>Out for Delivery</p>
              <small><%= order.statusDates["out-for-delivery"] ? new Date(order.statusDates["out-for-delivery"]).toDateString() : '' %></small>
            </div>

            <div class="step <%= order.status === 'delivered' || order.returnStatus ? 'active' : '' %>">
              <div class="circle"></div>
              <p>
                <% if(order.status==='delivered') { %> Delivered 
                <% } else if(order.returnStatus) { %> Returned 
                <% } else if(order.status==='cancelled') { %> Cancelled 
                <% } else { %> Expected Delivery <% } %>
              </p>
              <small>
                <% if(order.status==='delivered') { %>
                  <%= new Date(order.statusDates.delivered).toDateString() %>
                <% } else if(order.returnStatus) { %>
                  <%= new Date(order.statusDates.returned).toDateString() %>
                <% } else if(order.status==='cancelled') { %>
                  <%= new Date(order.statusDates.cancelled).toDateString() %>
                <% } else { %>
                  <%= order.expectedDate ? new Date(order.expectedDate).toDateString() : '' %>
                <% } %>
              </small>
            </div>
          </div>

          <!-- Buttons & Status -->
          <div class="d-flex justify-content-center flex-wrap mt-3">
            <% if (!['delivered','returned','cancelled'].includes(order.status)) { %>
              <button class="btn btn-danger btn-cancel"
                data-order-id="<%= order.orderId %>"
                data-variant-id="<%= order.variantId %>"
                data-product-id="<%= order.productId %>">
                Cancel Order
              </button>
            <% } else if(order.status==='delivered'){ %>
              <button class="btn btn-warning btn-return"
                data-order-id="<%= order.orderId %>"
                data-variant-id="<%= order.variantId %>"
                data-product-id="<%= order.productId %>"
                data-bs-toggle="modal"
                data-bs-target="#returnModal">
                Return
              </button>
            <% } %>

            <% if(order.status==='cancelled'){ %>
              <span class="badge bg-danger">Order Cancelled</span>
            <% } %>

            <% if(order.returnStatus==="pending"){ %>
              <span class="badge bg-warning">Return Request Pending</span>
            <% } else if(order.returnStatus==="approved"){ %>
              <span class="badge bg-info">Return Request Accepted</span>
            <% } else if(order.returnStatus==="refunded"){ %>
              <span class="badge bg-success">Amount Refunded</span>
            <% } else if(order.returnStatus==="rejected"){ %>
              <span class="badge bg-danger">Return Rejected</span>
            <% } %>
          </div>
        </div>
      <% }) %>

      <!-- Pagination -->
      <% if (totalPages> 1) { %>
      <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center mt-4">
          <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link" href="/orders?page=<%= currentPage - 1 %>">Previous</a>
          </li>
          <% for (let i=1; i <= totalPages; i++) { %>
          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
            <a class="page-link" href="/orders?page=<%= i %>"><%= i %></a>
          </li>
          <% } %>
          <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
            <a class="page-link" href="/orders?page=<%= currentPage + 1 %>">Next</a>
          </li>
        </ul>
      </nav>
      <% } %>
    </div>

    <%- include('../partials/footer') %>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/tracker.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/cancelOrder.js"></script>
    <%- include('../partials/successAlert') %>

    <!-- Return Modal -->
    <div class="modal fade" id="returnModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form action="/orders/return" method="POST">
            <div class="modal-header">
              <h5 class="modal-title">Reason for Return</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" name="orderId" id="modalOrderId">
              <input type="hidden" name="variantId" id="modalVariantId">
              <input type="hidden" name="productId" id="modalProductId">
              <label for="reason">Choose a reason:</label>
              <select name="reason" class="form-control mt-2" required>
                <option value="">-- Select Reason --</option>
                <option>Wrong Size</option>
                <option>Damaged Product</option>
                <option>Not as Described</option>
                <option>Other</option>
              </select>
            </div>
            <div class="modal-footer">
              <button type="submit" class="btn btn-danger">Submit</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </body>
</html>
