<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head', { title: 'Add Product' }) %>
<body>
  <div class="container-fluid">
    <div class="row min-vh-100">
      <%- include('../partials/adminDashboard') %>

      <div class="col-md-10 p-5">
        <h3 class="fw-bold mb-4">Add Product</h3>

        <form action="/admin/addProduct" method="POST" enctype="multipart/form-data">
          <!-- Product Name -->
          <div class="mb-3">
            <label class="form-label">Product Name</label>
            <input type="text" class="form-control" name="name" placeholder="Enter product name" value="<%= oldInput?.name || '' %>">
            <% if (errors?.name) { %><div class="text-danger"><%= errors.name %></div><% } %>
          </div>

          <!-- Description -->
          <div class="mb-3">
            <label class="form-label">Description</label>
            <textarea class="form-control" name="description" rows="3"><%= oldInput?.description || '' %></textarea>
            <% if (errors?.description) { %><div class="text-danger"><%= errors.description %></div><% } %>
          </div>

           <!-- Upload Images -->
          <div class="mb-3 bg-light">
            <label class="form-label">Edit photos</label>
            <div class="d-flex gap-3 border rounded-2 p-5">
              <div class="d-flex gap-3 p-5">
                <% for (let i = 0; i < 3; i++) { %>
                  <div class="upload-box col position-relative text-center me-5 image">
                    <input type="file" name="images" class="image-input d-none" accept="image/*">
                    <img src="https://img.icons8.com/ios/50/image--v1.png" alt="Upload" class="upload-preview" style="width: 40px;" />
                    <div>Add Image</div>
                  </div>
                <% } %>
              </div> 
            </div>
            <% if (errors?.images) { %>
              <div class="text-danger mt-1"><%= errors.images %></div>
            <% } %>
          </div>

          <!-- General Dropdowns -->
          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <label class="form-label">Gender</label>
              <select class="form-select" name="genderId">
                <option disabled selected>Select gender</option>
                <option value="male" <%= oldInput?.genderId === 'male' ? 'selected' : '' %>>Male</option>
                <option value="female" <%= oldInput?.genderId === 'female' ? 'selected' : '' %>>Female</option>
                <option value="unisex" <%= oldInput?.genderId === 'unisex' ? 'selected' : '' %>>Unisex</option>
              </select>
              <% if (errors?.genderId) { %><div class="text-danger"><%= errors.genderId %></div><% } %>
            </div>

            <div class="col-md-3">
              <label class="form-label">Product Type</label>
              <select class="form-select" name="productTypeId">
                <option disabled selected>Select type</option>
                <% productTypes.forEach(type => { %>
                  <option value="<%= type._id %>" <%= oldInput?.productTypeId == type._id ? 'selected' : '' %>><%= type.name %></option>
                <% }) %>
              </select>
              <% if (errors?.productTypeId) { %><div class="text-danger"><%= errors.productTypeId %></div><% } %>
            </div>

            
          </div>

          <!-- Variant Section -->
          <h5 class="mt-4">Product Variants</h5>
                <div id="variantContainer">
                  <% let variants = oldInput?.variants || [{}]; %>
                  <% variants.forEach((variant, index) => { %>
                    <div class="row g-3 mb-3 variant-group">

                      <div class="col-md-4">
                        <label class="form-label">Fit</label>
                        <select class="form-select" name="variants[<%= index %>][fitId]">
                          <option disabled selected>Select fit</option>
                          <% fits.forEach(fit => { %>
                            <option value="<%= fit._id %>" <%= variant.fitId == fit._id ? 'selected' : '' %>><%= fit.name %></option>
                          <% }) %>
                        </select>
                        <% if (errors?.[`variants[${index}].fitId`]) { %>
                          <div class="text-danger"><%= errors[`variants[${index}].fitId`] %></div>
                        <% } %>
                      </div>

                      <div class="col-md-4">
                        <label class="form-label">Color</label>
                        <select class="form-select" name="variants[<%= index %>][colorId]">
                          <option disabled selected>Select Colour</option>
                          <% colors.forEach(color => { %>
                            <option value="<%= color._id %>" <%= variant.colorId == color._id ? 'selected' : '' %>><%= color.name %></option>
                          <% }) %>
                        </select>
                        <% if (errors?.[`variants[${index}].colorId`]) { %>
                            <div class="text-danger"><%= errors[`variants[${index}].colorId`] %></div>
                        <% } %>
                      </div>

                      <div class="col-md-4">
                        <label class="form-label">Size</label>
                        <select class="form-select" name="variants[<%= index %>][size]">
                          <option disabled selected>Select Size</option>
                          <% ['XS', 'S', 'M', 'L', 'XL', 'XXL'].forEach(size => { %>
                            <option value="<%= size %>" <%= variant.size == size ? 'selected' : '' %>><%= size %></option>
                          <% }) %>
                        </select>
                        <% if (errors?.[`variants[${index}].size`]) { %>
                          <div class="text-danger"><%= errors[`variants[${index}].size`] %></div>
                        <% } %>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Base Price</label>
                        <input type="number" class="form-control" name="variants[<%= index %>][basePrice]" value="<%= variant.basePrice || '' %>">
                        <% if (errors?.[`variants[${index}].basePrice`]) { %>
                          <div class="text-danger"><%= errors[`variants[${index}].basePrice`] %></div>
                        <% } %>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Discount Price</label>
                        <input type="number" class="form-control" name="variants[<%= index %>][discountPrice]" value="<%= variant.discountPrice || '' %>">
                        <% if (errors?.[`variants[${index}].discountPrice`]) { %>
                          <div class="text-danger"><%= errors[`variants[${index}].discountPrice`] %></div>
                        <% } %>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Stock</label>
                        <input type="number" class="form-control" name="variants[<%= index %>][stock]" value="<%= variant.stock || '' %>">
                        <% if (errors?.[`variants[${index}].stock`]) { %>
                          <div class="text-danger"><%= errors[`variants[${index}].stock`] %></div>
                        <% } %>
                      </div>
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                      <% if (index >= variants.length) { %> 
                        <button type="button" class="btn btn-danger remove-variant-btn">Remove</button>
                      <% } %>
                    </div>

                  <% }); %>
                </div>

          <!-- Add Variant Button -->
          <div class="mb-3">
            <button type="button" class="btn btn-outline-secondary" id="addVariantBtn">+ Add Another Variant</button>
          </div>

          <!-- Buttons -->
          <div class="d-flex justify-content-end">
            <a href="/admin/products" class="btn btn-outline-dark me-2">Cancel</a>
            <button type="submit" class="btn btn-dark">Save Product</button>
          </div>
        </form>
      </div>
    </div>

    <footer class="text-center py-4 small text-muted border-top mt-4 fw-bold">
      Â© 2025 | ShopCart | All Rights Reserved.
    </footer>
  </div>

  <!-- Cropper Modal -->
<div class="modal fade" id="cropperModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Crop Image</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="cropperImage" style="max-width:100%;"/>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="cropImageBtn" class="btn btn-dark">Crop & Save</button>
      </div>
    </div>
  </div>
</div>
<script>
  let cropper;
let activeInput; // to remember which input triggered cropping
const cropperModal = new bootstrap.Modal(document.getElementById('cropperModal'));
const cropperImage = document.getElementById('cropperImage');
const cropImageBtn = document.getElementById('cropImageBtn');

// Handle image input selection
document.querySelectorAll('.image-input').forEach((input) => {
  input.addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (file) {
      activeInput = input; // store reference of current input

      const reader = new FileReader();
      reader.onload = () => {
        cropperImage.src = reader.result;
        cropperModal.show();

        // destroy old cropper if exists
        if (cropper) cropper.destroy();

        cropper = new Cropper(cropperImage, {
          aspectRatio: 1,      // square, change if needed
          viewMode: 2,
          autoCropArea: 1,
          responsive: true,
        });
      };
      reader.readAsDataURL(file);
    }
  });
});

// Crop & Save Button
cropImageBtn.addEventListener('click', () => {
  if (!cropper || !activeInput) return;

  const canvas = cropper.getCroppedCanvas({
    width: 600,   // output size
    height: 600,
  });

  canvas.toBlob((blob) => {
    const file = new File([blob], "cropped.jpg", { type: "image/jpeg" });

    // Replace the input file with cropped one
    const dataTransfer = new DataTransfer();
    dataTransfer.items.add(file);
    activeInput.files = dataTransfer.files;

    // Update preview image
    const preview = activeInput.parentElement.querySelector('.upload-preview');
    preview.src = URL.createObjectURL(file);

    cropperModal.hide();
    cropper.destroy();
    cropper = null;
  }, 'image/jpeg', 0.9);
});

</script>
  
  <script src="/js/addproduct.js"></script>
  <script src="/js/image.js"></script>
  <link  href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

 
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
