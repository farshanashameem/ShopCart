<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head', { title: 'Add Product' }) %>

  <body>
    <div class="container-fluid">
      <div class="row min-vh-100">
        <%- include('../partials/adminDashboard') %>

          <div class="col-md-10 p-5">
            <h3 class="fw-bold mb-4">Add Product</h3>

            <form action="/admin/editProduct" method="POST" enctype="multipart/form-data">
              <input type="hidden" value="<%= product._id%>" name="productId">
              <!-- Product Name -->
              <div class="mb-3">
                <label class="form-label">Product Name</label>
                <input type="text" class="form-control" name="name" placeholder="Enter product name"
                  value="<%= oldInput?.name || product.name %>">
                <% if (errors?.name) { %>
                  <div class="text-danger">
                    <%= errors.name %>
                  </div>
                  <% } %>
              </div>

              <!-- Description -->
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="description"
                  rows="3"><%= oldInput?.description || product.description %></textarea>
                <% if (errors?.description) { %>
                  <div class="text-danger">
                    <%= errors.description %>
                  </div>
                  <% } %>
              </div>

              <!-- Upload Images -->
              <div class="mb-3 bg-light">
                <label class="form-label">Edit photos</label>
                <div class="d-flex gap-3 border rounded-2 p-5">
                  <div class="d-flex gap-3 p-5">
                    <% for (let i=0; i < 3; i++) { %>
                      <div class="upload-box col position-relative text-center me-5 image">
                        <input type="file" name="images" class="image-input d-none" accept="image/*">
                        <img src="https://img.icons8.com/ios/50/image--v1.png" alt="Upload" class="upload-preview"
                          style="width: 40px;" />
                        <div>Add Image</div>
                      </div>
                      <% } %>
                  </div>
                </div>
                <% if (errors?.images) { %>
                  <div class="text-danger mt-1">
                    <%= errors.images %>
                  </div>
                  <% } %>
              </div>
              <!-- General Dropdowns -->
              <div class="row g-3 mb-3">
                <div class="col-md-3">
                  <label class="form-label">Gender</label>
                  <select class="form-select" name="genderId">
                    <option disabled selected>Select gender</option>
                    <option value="male" <%=(oldInput?.genderId || product.genderId)==='male' ? 'selected' : '' %>>Male
                    </option>
                    <option value="female" <%=(oldInput?.genderId || product.genderId)==='female' ? 'selected' : '' %>
                      >Female</option>
                    <option value="unisex" <%=(oldInput?.genderId || product.genderId)==='unisex' ? 'selected' : '' %>
                      >Unisex</option>

                  </select>
                  <% if (errors?.genderId) { %>
                    <div class="text-danger">
                      <%= errors.genderId %>
                    </div>
                    <% } %>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Product Type</label>
                  <select class="form-select" name="productTypeId">
                    <option disabled selected>Select type</option>
                    <% productTypes.forEach(type=> { %>
                      <option value="<%= type._id %>" <%=(oldInput?.productTypeId ||
                        product.productTypeId?.toString())==type._id.toString() ? 'selected' : '' %>>
                        <%= type.name %>
                      </option>
                      <% }) %>
                  </select>
                  <% if (errors?.productTypeId) { %>
                    <div class="text-danger">
                      <%= errors.productTypeId %>
                    </div>
                    <% } %>
                </div>


              </div>

              <!-- Variant Section -->
              <h5 class="mt-4">Product Variants</h5>
              <div id="variantContainer">
               <% let variantList = oldInput?.variants || variants; %>
                  <% variantList.forEach((variant, index)=> { %>

                    <div class="row g-3 mb-3 variant-group">
                       <input type="hidden" name="variants[<%= index %>][_id]" value="<%= variant._id %>">
                      <div class="col-md-4">
                        <label class="form-label">Fit</label>
                        <select class="form-select" name="variants[<%= index %>][fitId]">
                          <option disabled selected>Select fit</option>
                          <% fits.forEach(fit=> { %>
                            <option value="<%= fit._id %>" <%=variant.fitId?.toString()===fit._id.toString()
                              ? 'selected' : '' %>
                              ><%= fit.name %>
                            </option>
                            <% }) %>
                        </select>
                        <% if (errors?.[`variants[${index}].fitId`]) { %>
                          <div class="text-danger">
                            <%= errors[`variants[${index}].fitId`] %>
                          </div>
                          <% } %>
                      </div>

                      <div class="col-md-4">
                        <label class="form-label">Color</label>
                        <select class="form-select" name="variants[<%= index %>][colorId]">
                          <option disabled selected>Select Colour</option>
                          <% colors.forEach(color=> { %>
                            <option value="<%= color._id %>" <%=variant.colorId.toString()===color._id.toString()
                              ? 'selected' : '' %>
                              ><%= color.name %>
                            </option>
                            <% }) %>
                        </select>
                        <% if (errors?.[`variants[${index}].colorId`]) { %>
                          <div class="text-danger">
                            <%= errors[`variants[${index}].colorId`] %>
                          </div>
                          <% } %>
                      </div>

                      <div class="col-md-4">
                        <label class="form-label">Size</label>
                        <select class="form-select" name="variants[<%= index %>][size]">
                          <option disabled selected>Select Size</option>
                          <% ['XS', 'S' , 'M' , 'L' , 'XL' , 'XXL' ].forEach(size=> { %>
                            <option value="<%= size %>" <%=variant.size==size ? 'selected' : '' %>><%= size %>
                            </option>
                            <% }) %>
                        </select>
                        <% if (errors?.[`variants[${index}].size`]) { %>
                          <div class="text-danger">
                            <%= errors[`variants[${index}].size`] %>
                          </div>
                          <% } %>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Base Price</label>
                        <input type="number" class="form-control" name="variants[<%= index %>][basePrice]"
                          value="<%= variant.basePrice || ''%>">
                        <% if (errors?.[`variants[${index}].basePrice`]) { %>
                          <div class="text-danger">
                            <%= errors[`variants[${index}].basePrice`] %>
                          </div>
                          <% } %>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Discount Price</label>
                        <input type="number" class="form-control" name="variants[<%= index %>][discountPrice]"
                          value="<%= variant.discountPrice || ''%>">
                        <% if (errors?.[`variants[${index}].discountPrice`]) { %>
                          <div class="text-danger">
                            <%= errors[`variants[${index}].discountPrice`] %>
                          </div>
                          <% } %>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Stock</label>
                        <input type="number" class="form-control" name="variants[<%= index %>][stock]"
                          value="<%= variant.stock || '' %>">
                        <% if (errors?.[`variants[${index}].stock`]) { %>
                          <div class="text-danger">
                            <%= errors[`variants[${index}].stock`] %>
                          </div>
                          <% } %>
                      </div>
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                      <% if (index >= variantList.length) { %> 
                        <button type="button" class="btn btn-danger remove-variant-btn">Remove</button>
                      <% } %>
                    </div>

                    <% }); %>

                    
              </div>

              <!-- Add Variant Button -->
              <div class="mb-3">
                <button type="button" class="btn btn-outline-secondary" id="addVariantBtn">+ Add Another
                  Variant</button>
              </div>

              <!-- Buttons -->
              <div class="d-flex justify-content-end">
                <a href="/admin/products" class="btn btn-outline-dark me-2">Cancel</a>
                <button type="submit" class="btn btn-dark">Save Product</button>
              </div>
            </form>
          </div>
      </div>

      <footer class="text-center py-4 small text-muted border-top mt-4 fw-bold">
        © 2025 | ShopCart | All Rights Reserved.
      </footer>
    </div>


    <script src="/js/addproduct.js"></script>
    <script src="/js/image.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>

</html>