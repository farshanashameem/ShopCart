<!DOCTYPE html>
<html lang="en">
<%- include('../partials/head', { title: 'Edit Product' }) %>

  <body>
    <div class="container-fluid">
      <div class="row min-vh-100">
        <%- include('../partials/adminDashboard') %>

          <div class="col-md-10 p-5">
            <h3 class="fw-bold mb-4">Edit Product </h3>
                  

            <form action="/admin/editProduct" method="POST" enctype="multipart/form-data">
              <input type="hidden" value="<%= product._id%>" name="productId">
              <!-- Product Name -->
              <div class="mb-3">
                <label class="form-label">Product Name</label>
                <input type="text" class="form-control" name="name" placeholder="Enter product name"
                  value="<%= oldInput?.name || product.name %>">
                <% if (errors?.name) { %>
                  <div class="text-danger">
                    <%= errors.name %>
                  </div>
                  <% } %>
              </div>

              <!-- Description -->
              <div class="mb-3">
                <label class="form-label">Description</label>
                <textarea class="form-control" name="description"
                  rows="3"><%= oldInput?.description || product.description %></textarea>
                <% if (errors?.description) { %>
                  <div class="text-danger">
                    <%= errors.description %>
                  </div>
                  <% } %>
              </div>

           <!-- Upload Section -->
<div class="mb-3">
  <label class="form-label">Edit Product Images (max 3)</label>
  <div class="d-flex flex-wrap gap-3" id="imageContainer">
    <% 
      // Use previously submitted images first (oldInput), fallback to DB variant images
      const variantImages = oldInput?.existingImages
        ? Object.values(oldInput.existingImages) // {0: 'path', 1:'path'} â†’ ['path0', 'path1']
        : (variants.length > 0 && variants[0].images)
          ? variants[0].images
          : [];
      
      for (let i = 0; i < 3; i++) { 
        const img = variantImages[i];
    %>
      <div class="upload-box position-relative text-center" data-slot="<%= i %>">
        <input type="file" class="d-none image-input" name="images<%= i %>" accept="image/*">
        
        <% if (img) { %>
          <input type="hidden" name="existingImages[<%= i %>]" value="<%= img %>">
          <div class="position-relative d-inline-block">
            <img src="<%= img %>" class="upload-preview img-thumbnail" style="width:120px;height:120px;object-fit:cover;cursor:pointer;">
            <button type="button" class="btn btn-sm btn-danger remove-image-btn position-absolute" style="top:2px;right:2px">&times;</button>
          </div>
        <% } else { %>
          <div class="upload-preview d-flex align-items-center justify-content-center bg-light border rounded" style="width:120px;height:120px;cursor:pointer;">
            <span class="text-muted">+</span>
          </div>
        <% } %>
        <small class="text-muted d-block text-center">Click to upload</small>
      </div>
    <% } %>
  </div>
</div>



                <!-- Crop Modal -->
                <div class="modal fade" id="cropModal" tabindex="-1">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title">Crop Image</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body text-center">
                        <img id="cropImage" class="img-fluid" />
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" id="cropSave" class="btn btn-primary">Save</button>
                      </div>
                    </div>
                  </div>
                </div>



             



     
 


              <!-- General Dropdowns -->
              <div class="row g-3 mb-3">
                <div class="col-md-3">
                  <label class="form-label">Gender</label>
                  <select class="form-select" name="genderId">
                    <option disabled selected>Select gender</option>
                    <option value="male" <%=(oldInput?.genderId || product.genderId)==='male' ? 'selected' : '' %>>Male
                    </option>
                    <option value="female" <%=(oldInput?.genderId || product.genderId)==='female' ? 'selected' : '' %>
                      >Female</option>
                    <option value="unisex" <%=(oldInput?.genderId || product.genderId)==='unisex' ? 'selected' : '' %>
                      >Unisex</option>

                  </select>
                  <% if (errors?.genderId) { %>
                    <div class="text-danger">
                      <%= errors.genderId %>
                    </div>
                    <% } %>
                </div>

                <div class="col-md-3">
                  <label class="form-label">Product Type</label>
                  <select class="form-select" name="productTypeId">
                    <option disabled selected>Select type</option>
                    <% productTypes.forEach(type=> { %>
                      <option value="<%= type._id %>" <%=(oldInput?.productTypeId ||
                        product.productTypeId?.toString())==type._id.toString() ? 'selected' : '' %>>
                        <%= type.name %>
                      </option>
                      <% }) %>
                  </select>
                  <% if (errors?.productTypeId) { %>
                    <div class="text-danger">
                      <%= errors.productTypeId %>
                    </div>
                    <% } %>
                </div>


              </div>

              <!-- Variant Section -->
              <h5 class="mt-4">Product Variants</h5>
              <div id="variantContainer">
               <% let variantList = oldInput?.variants || variants; %>
                  <% variantList.forEach((variant, index)=> { %>

                    <div class="row g-3 mb-3 variant-group">
                       <input type="hidden" name="variants[<%= index %>][_id]" value="<%= variant._id %>">
                      <div class="col-md-4">
                        <label class="form-label">Fit</label>
                        <select class="form-select" name="variants[<%= index %>][fitId]">
                          <option disabled selected>Select fit</option>
                          <% fits.forEach(fit=> { %>
                            <option value="<%= fit._id %>" <%=variant.fitId?.toString()===fit._id.toString()
                              ? 'selected' : '' %>
                              ><%= fit.name %>
                            </option>
                            <% }) %>
                        </select>
                        <% if (errors?.[`variants[${index}].fitId`]) { %>
                          <div class="text-danger">
                            <%= errors[`variants[${index}].fitId`] %>
                          </div>
                          <% } %>
                      </div>

                      <div class="col-md-4">
                        <label class="form-label">Color</label>
                        <select class="form-select" name="variants[<%= index %>][colorId]">
                          <option disabled selected>Select Colour</option>
                          <% colors.forEach(color=> { %>
                            <option value="<%= color._id %>" <%=variant.colorId.toString()===color._id.toString()
                              ? 'selected' : '' %>
                              ><%= color.name %>
                            </option>
                            <% }) %>
                        </select>
                        <% if (errors?.[`variants[${index}].colorId`]) { %>
                          <div class="text-danger">
                            <%= errors[`variants[${index}].colorId`] %>
                          </div>
                          <% } %>
                      </div>

                      <div class="col-md-4">
                        <label class="form-label">Size</label>
                        <select class="form-select" name="variants[<%= index %>][size]">
                          <option disabled selected>Select Size</option>
                          <% ['XS', 'S' , 'M' , 'L' , 'XL' , 'XXL' ].forEach(size=> { %>
                            <option value="<%= size %>" <%=variant.size==size ? 'selected' : '' %>><%= size %>
                            </option>
                            <% }) %>
                        </select>
                        <% if (errors?.[`variants[${index}].size`]) { %>
                          <div class="text-danger">
                            <%= errors[`variants[${index}].size`] %>
                          </div>
                          <% } %>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Base Price</label>
                        <input type="number" class="form-control" name="variants[<%= index %>][basePrice]"
                          value="<%= variant.basePrice || ''%>">
                        <% if (errors?.[`variants[${index}].basePrice`]) { %>
                          <div class="text-danger">
                            <%= errors[`variants[${index}].basePrice`] %>
                          </div>
                          <% } %>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Discount Price</label>
                        <input type="number" class="form-control" name="variants[<%= index %>][discountPrice]"
                          value="<%= variant.discountPrice || ''%>">
                        <% if (errors?.[`variants[${index}].discountPrice`]) { %>
                          <div class="text-danger">
                            <%= errors[`variants[${index}].discountPrice`] %>
                          </div>
                          <% } %>
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Stock</label>
                        <input type="number" class="form-control" name="variants[<%= index %>][stock]"
                          value="<%= variant.stock || '' %>">
                        <% if (errors?.[`variants[${index}].stock`]) { %>
                          <div class="text-danger">
                            <%= errors[`variants[${index}].stock`] %>
                          </div>
                          <% } %>
                      </div>
                    </div>

                    <div class="col-md-3 d-flex align-items-end">
                      <% if (index >= variantList.length) { %> 
                        <button type="button" class="btn btn-danger remove-variant-btn">Remove</button>
                      <% } %>
                    </div>

                    <% }); %>

                    
              </div>

              <!-- Add Variant Button -->
              <div class="mb-3">
                <button type="button" class="btn btn-outline-secondary" id="addVariantBtn">+ Add Another
                  Variant</button>
              </div>

              <!-- Buttons -->
              <div class="d-flex justify-content-end">
                <a href="/admin/products" class="btn btn-outline-dark me-2">Cancel</a>
                <button type="submit" class="btn btn-dark">Save Product</button>
              </div>
            </form>
          </div>
      </div>

      <footer class="text-center py-4 small text-muted border-top mt-4 fw-bold">
        Â© 2025 | ShopCart | All Rights Reserved.
      </footer>
    </div>


    <script src="/js/addproduct.js"></script>
    <script src="/js/image.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="/js/cropper.js"></script>


</html>